substitutions: 
  device_internal_name: waveshare-7inch-1
  device_friendly_name: Waveshare 7inch 1
  friendly_devicename: Waveshare 7inch 1
  friendly_name: Waveshare 7inch 1
  device_sampling_time: 30s


### Board Configuration
esphome:
  name: ${device_internal_name}
  friendly_name: ${device_friendly_name}
  platformio_options:
    build_flags: "-DBOARD_HAS_PSRAM"
    board_build.arduino.memory_type: qio_opi
    board_build.flash_mode: dio
    board_upload.maximum_ram_size: 524288

psram:
  mode: octal
  speed: 120MHz

esp32:
  board: esp32-s3-devkitc-1
  variant: ESP32S3
  flash_size: 8MB
  cpu_frequency: 240MHz 
  framework:
    type: esp-idf
    advanced:
      enable_idf_experimental_features: true
    sdkconfig_options:
      COMPILER_OPTIMIZATION_SIZE: y
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESPTOOLPY_FLASHSIZE_8MB: "y"
      CONFIG_FREERTOS_HZ: "1000"
      CONFIG_ESP_DEFAULT_CPU_FREQ_MHZ_240: y
      CONFIG_ESPTOOLPY_FLASHMODE_QIO: y
      CONFIG_ESPTOOLPY_FLASHFREQ_120M: y
      CONFIG_SPIRAM_MODE_OCT: y
      CONFIG_IDF_EXPERIMENTAL_FEATURES: y
      CONFIG_SPIRAM_SPEED_120M: y
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_SPIRAM_RODATA: y
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: y
      CONFIG_COMPILER_OPTIMIZATION_PERF: y

# WiFi (with static IP)
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

# OTA
ota:
  - platform: esphome
    password: !secret ota_password

# Home Assistant API with encryption and renamed ID
api:
  encryption:
    key: "aAY0fYv5Avc9gqClXa4mY8OGxyTouxCPXxOO8QNFj8U="
  on_client_connected:
    - if:
        condition:
          lambda: 'return (0 == client_info.find("Home Assistant "));'
        then:
          - switch.turn_on: lcdbacklight
          - logger.log: "Home Assistant connected!"  # Add this

# IO Extender
ch422g:
  - id: ch422g_hub

### Restart unit
button:
- platform: restart
  name: $friendly_name Restart

### Switch
switch:
  - platform: safe_mode
    name: Use Safe Mode
    id: device_safe_mode

  - platform: gpio
    id: lcdbacklight
    name: lcdbacklight
    pin:
      ch422g: ch422g_hub
      number: 2
      mode:
        output: true
      inverted: false
    restore_mode: ALWAYS_ON

  - platform: template
    name: Antiburn
    id: switch_antiburn
    icon: mdi:television-shimmer
    optimistic: true
    entity_category: "config"
    turn_on_action:
      - logger.log: "Starting Antiburn"
      - if:
          condition: lvgl.is_paused
          then:
            - lvgl.resume:
            - lvgl.widget.redraw:
      - lvgl.pause:
          show_snow: true
    turn_off_action:
      - logger.log: "Stopping Antiburn"
      - if:
          condition: lvgl.is_paused
          then:
            - lvgl.resume:
            - lvgl.widget.redraw:

# I2C for touchscreen
i2c:
  sda: GPIO08
  scl: GPIO09
  scan: true
  id: bus_a

# Logger (set to VERY_VERBOSE for detailed debugging)
logger:
  baud_rate: 115200
  level: VERY_VERBOSE  # Keep high verbosity to debug crash

### Images
image:
  - file: "images/background.png"
    id: background
    # resize: 480x320
    # type: RGB565
    resize: 800x480
    type: RGB

# Colors (from working config)
color:
  - id: my_red
    red: 100%
    green: 0%
    blue: 0%
  - id: my_yellow
    red: 100%
    green: 100%
    blue: 0%
  - id: my_green
    red: 0%
    green: 100%
    blue: 0%
  - id: my_gray
    red: 50%
    green: 50%
    blue: 50%
  - id: my_white
    red: 100%
    green: 100%
    blue: 100%
  - id: my_black
    red: 0%
    green: 0%
    blue: 0%

# Display setup
display:
  - platform: rpi_dpi_rgb
    id: my_display
    update_interval: never
    auto_clear_enabled: false
    color_order: RGB
    pclk_frequency: 16MHZ
    dimensions:
      width: 800
      height: 480
    de_pin:
      number: 5
    hsync_pin:
      number: 46
      ignore_strapping_warning: true
    vsync_pin:
      number: 3
      ignore_strapping_warning: true
    pclk_pin: 7
    pclk_inverted: true
    reset_pin:
      ch422g: ch422g_hub
      number: 3
    hsync_back_porch: 8
    hsync_front_porch: 8
    hsync_pulse_width: 4
    vsync_back_porch: 16
    vsync_front_porch: 16
    vsync_pulse_width: 4
    data_pins:
      red:
        - 1
        - 2
        - 42
        - 41
        - 40
      blue:
        - 14
        - 38
        - 18
        - 17
        - 10
      green:
        - 39
        - 0
        - 45
        - 48
        - 47
        - 21

binary_sensor:
  - platform: homeassistant
    id: master_bedroom_light_state
    entity_id: switch.master_bedroom_lights
    on_state:
      then:
        - lvgl.widget.update:
            id: master_bedroom_light_button
            state:
              checked: !lambda return x;
  - platform: homeassistant
    id: master_bedroom_tv_light_state
    entity_id: light.master_tv_light
    on_state:
      then:
        - lvgl.widget.update:
            id: master_bedroom_tv_button
            state:
              checked: !lambda return x;

# Touchscreen (updated to match new config)
touchscreen:
  platform: gt911
  id: my_touch
  interrupt_pin: GPIO4
  reset_pin:
    ch422g: ch422g_hub
    number: 1
    mode: OUTPUT
  on_touch:
    - lambda: |-
        ESP_LOGI("Touch", "Touch detected at x=%d, y=%d", touch.x, touch.y);
  on_update:
    - lambda: |-
        for (auto touch: touches)  {
            if (touch.state <= 2) {
              ESP_LOGI("Touch points:", "id=%d x=%d, y=%d x.raw=%d, y.raw=%d", touch.id, touch.x, touch.y, touch.x_raw, touch.y_raw);
            }
        }
  on_release:
    then:
      - if:
          condition: lvgl.is_paused
          then:
            - lvgl.resume:
            - lvgl.widget.redraw:

# LVGL setup with a single button
lvgl:
  displays: my_display
  touchscreens: my_touch
  buffer_size: 10%
  disp_bg_image: background
  color_depth: 16
  theme:
    arc:
      scroll_on_focus: true
    slider:
      scroll_on_focus: true
    button:
      bg_color: 0x4D93DD
      bg_grad_dir: VER
      bg_opa: COVER
      border_color: 0x0077b3
      border_width: 2
      pressed: # set some button colors to be different in pressed state
        bg_color: 0xFFD512
      checked: # set some button colors to be different in checked state
        bg_color: 0x32CD32
        text_color: 0xFFFFFF
      scroll_on_focus: true
    #   text_font: roboto_56
    #   text_color: my_white
    #   focused:
    #     border_color: my_gray
    # label:
    #   # outline_width: 1 ## for testing the grid, comment out when done
    #   text_font: roboto_56
    #   text_color: my_white

  gradients:
    - id: color_bar
      direction: ver
      dither: none
      stops:
        - color: 0x4D93DD
          position: 0%
        - color: 0x4BDCE3
          position: 20%
        - color: 0xA1EDDE
          position: 40%
        - color: 0xEFF2B1
          position: 60%
        - color: 0xFFD512
          position: 80%
        - color: 0xF53B3B
          position: 100%

  pages:
    - id: main_page
      widgets:
        - button:
            id: master_bedroom_light_button
            checkable: true
            x: 20
            y: 20
            width: 100
            height: 100
            radius: 10
            bg_color: my_gray
            text_color: my_white
            on_click:
              - logger.log: "Button clicked!"
              - homeassistant.action:
                  action: switch.toggle
                  data:
                    entity_id: switch.master_bedroom_lights
            widgets:
              - label:
                  text: "Master Bedroom Light"
                  align: center
                  long_mode: wrap
                  text_align: center    # Centers each wrapped line
                  width: 80            # Slightly smaller than button for padding
        - button:
            id: master_bedroom_tv_button
            checkable: true
            x: 140
            y: 20
            width: 100
            height: 100
            radius: 10
            bg_color: my_gray
            text_color: my_white
            on_click:
              then:
                - homeassistant.action:
                    action: light.toggle
                    data:
                      entity_id: light.master_tv_light
            widgets:
              - label:
                  text: "Master Bedroom TV Light"
                  align: center
                  long_mode: wrap
                  text_align: center    # Centers each wrapped line
                  width: 80            # Slightly smaller than button for padding
        - button:
            id: extra_bedroom_button
            checkable: true
            x: 20
            y: 140
            width: 100
            height: 100
            radius: 10
            bg_color: my_gray
            text_color: my_white
            on_click:
              then:
                - homeassistant.action:
                    action: switch.toggle
                    data:
                      entity_id: switch.extra_bedroom_light
            widgets:
              - label:
                  text: "Extra Bedroom Light"
                  align: center
                  long_mode: wrap
                  text_align: center    # Centers each wrapped line
                  width: 80            # Slightly smaller than button for padding

